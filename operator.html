<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Operator Page - Live Translation</title>
<style>
    body { font-family: Arial; padding: 20px; }
    button { margin: 5px; padding: 10px; }
    #status { margin-bottom: 20px; }
    #transcription { font-size: 1.2em; margin-top: 20px; min-height: 50px; border: 1px solid #ccc; padding: 10px; }
    .status-label { font-weight: bold; }
</style>
</head>
<body>

<h1>Operator Control</h1>

<div id="status">
    <div><span class="status-label">Session Status:</span> <span id="session_status">Unknown</span></div>
    <div><span class="status-label">Recorder Status:</span> <span id="recorder_status">Unknown</span></div>
</div>

<div>
    <button id="start_session">Start Session</button>
    <button id="end_session">End Session</button>
</div>

<div>
    <button id="start_recorder">Start Recorder</button>
    <button id="stop_recorder">Stop Recorder</button>
</div>

<div id="transcription">Waiting for English transcription...</div>

<script>
const sessionSpan = document.getElementById("session_status");
const recorderSpan = document.getElementById("recorder_status");
const transcriptionDiv = document.getElementById("transcription");

// ---------------------
// WebSocket for live English text
// ---------------------
const ws = new WebSocket("ws://localhost:8000/ws/operator");

ws.onopen = () => {
    console.log("Connected to server WebSocket.");
};

// In ws.onmessage handler
ws.onmessage = (event) => {
    const data = JSON.parse(event.data);

    if (data.type === "status") {
        sessionSpan.innerText = data.session_active ? "Active" : "Inactive";
        recorderSpan.innerText = data.recorder_running ? "Running" : "Stopped";
    }

    // Live interim (partial)
    if (data.type === "partial") {
        transcriptionDiv.innerText = data.text || " ";
    }

    // Finalized English text (committed)
    if (data.type === "english_text") {
        transcriptionDiv.innerText = data.text;
    }

    // other handlers unchanged
};


ws.onclose = () => {
    sessionSpan.innerText = "Disconnected";
    recorderSpan.innerText = "Disconnected";
    transcriptionDiv.innerText = "Connection lost.";
};

// ---------------------
// Button handlers for API
// ---------------------
async function postJson(url, body={}) {
    const resp = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
    });
    return resp.json();
}

document.getElementById("start_session").onclick = async () => {
    const resp = await postJson("/start_session");
    console.log(resp);
};

document.getElementById("end_session").onclick = async () => {
    const resp = await postJson("/end_session");
    console.log(resp);
};

document.getElementById("start_recorder").onclick = async () => {
    const device = "default"; // change if needed
    const samplerate = 16000;
    const resp = await postJson("/start_recorder", {device, samplerate});
    if (resp.status === "error") {
        alert("Recorder not started: " + resp.detail);
    } else if (resp.status === "recorder_already_running") {
        alert("Recorder is already running.");
    } else {
        console.log("Recorder started, PID:", resp.pid);
    }
};

document.getElementById("stop_recorder").onclick = async () => {
    const resp = await postJson("/stop_recorder");
    console.log(resp);
};

// ---------------------
// Optional: Poll status every 2 seconds
// ---------------------
setInterval(async () => {
    // status broadcast from server already updates via WS; optional polling fallback
}, 2000);
</script>

</body>
</html>
